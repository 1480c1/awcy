<!DOCTYPE HTML>
<html>
<head>
<title>Are We Compressed Yet?</title>
<meta http-equiv="X-UA-Compatible" content="IE=Edge">
<script src="jquery-2.1.1.js"></script>
<script src="jquery.flot.js"></script>
<script src="jquery.flot.axislabels.js"></script>
<script>

function regenerate_graph() {
  var selected_graphs = [];
  var metric_index = parseInt($('#metric').val());
  $('.run').each(function() {
    if ($(this).hasClass('selected')) {
      selected_graphs.push($(this).html());
    }
  });
  if (selected_graphs.length < 2) {
    $("#rd_graph").html('Please select 2 or more runs.');
    return;
  }
  $("#rd_graph").html('');
  var graph_requests = [];
  var outfile = $("#video_name").val();
  bd_rate(selected_graphs,outfile);
  var filter_task = $('#run_filter_task').val();
  var logarithmic = $('#logarithmic').prop('checked');
  for (var i in selected_graphs) {
    graph_requests.push($.get('/runs/'+selected_graphs[i]+'/'+filter_task+'/'+outfile));
  }
  $.when.apply($,graph_requests).done(function() {
    // draw chart
    var curves = [];
    for (var j in arguments) {
      var curve = [];
      var data = arguments[j][0];
      var lines = data.split('\n');
      for (var i in lines) {
        var line = lines[i].split(' ');
        var point = [line[2]*8/line[1],line[3+metric_index]];
        curve.push(point);
      }
      var series = {
        data: curve,
        label: selected_graphs[j]
      };
      curves.push(series);
    }
    var options = {
      xaxis: {
        axisLabel: 'Bits per Pixel'
      },
      yaxis: {
        axisLabel: 'Picture quality (dB)'
      },
      legend: {
        show: true,
        position: 'se'
      },
      series: {
        lines: {
          lineWidth: 1
        },
        shadowSize: 0
      }
    };
    if (logarithmic) {
      options.xaxis.transform = function (v) { return Math.log(v); };
      options.xaxis.inverseTransform = function (v) { return Math.exp(v); };
    }
    $.plot('#rd_graph',curves,options);
  });
};
function load_job_queue() {
  $.getJSON('/job_queue.json', function(data) {
    for (var i in data) {
      var job = data[i];
      var job_div = $('<div>');
      job_div.html(job.run_id);
      $('#job_queue').append(job_div);
    }
  });
  $.getJSON('/job', function(data) {
    var job = data;
    console.log(job);
    var job_div = $('#current_job');
    if (job) {
      job_div.html(job.run_id);
    } else {
      job_div.html('No jobs running');
    }
  });
}
function bd_rate(selected_graphs,outfile) {
  var filter_task = $('#run_filter_task').val();
  if (selected_graphs.length < 2) return;
  var req = {};
  req['a'] = selected_graphs[1];
  req['b'] = selected_graphs[0];
  req['set'] = filter_task;
  $('#bd_rate_title').html(req['a']+' → '+req['b']);
  req['file'] = outfile;
  $.get('/bd_rate',req,function(data) {
    $('#bd_rate').html(data);
  });
}
  
function baseName(str)
{
   var base = new String(str).substring(str.lastIndexOf('/') + 1); 
    if(base.lastIndexOf(".") != -1)       
        base = base.substring(0, base.lastIndexOf("."));
   return base;
}
function load_sets() {
  var filter_task = $('#run_filter_task').val();
  $.getJSON('/sets.json', function(data) {
    $('#video_name').html('');
    var total_option = $('<option>');
    total_option.html('Total');
    total_option.attr('value','total.out');
    $('#video_name').append(total_option);
    for (var i in data[filter_task]) {
      var file_in_set = baseName(data[filter_task][i]);
      var file_option = $('<option>');
      file_option.html(file_in_set);
      file_option.attr('value',file_in_set+'.y4m-daala.out');
      $('#video_name').append(file_option);
    }
  });
}
function load_runs() {
  var filter_task = $('#run_filter_task').val();
  load_sets();
  $.getJSON('/list.json', function(data) {
    data.sort(function(a,b) {
      return new Date(b.date) - new Date(a.date);
    });
    $('#runs').html('');
    for (var i in data) {
      var job = data[i];
      if (job.tasks.indexOf(filter_task) != -1) {
        var run = $('<div>').html(job.run_id);
        run.attr('class','run');
        run.on('click',function() {
          $(this).toggleClass('selected');
          regenerate_graph();
          return false;
        });
        $('#runs').append(run);
      }
    }
  });
}

$(function() {
  load_runs();
  var date = new Date();
  $('#run_id').val(date.toISOString().replace(/:/g,'-'));
  load_job_queue();
  load_sets();
});
</script>
<!-- <link rel="stylesheet" type="text/css" href="//icecast.org/assets/css/style.css" media="screen, print"> -->
<link rel="stylesheet" type="text/css" href="xiphbar.css" media="screen, print">
<link type="text/css" rel="stylesheet" href="awcy.css"></link>
</head>
<body>
<div id="xiphbar">
      <div>
        <a href="http://www.xiph.org/"><img src="xiph-community.svg" alt="the xiph open source community"></a>
        <ul>
          
            <li><a href="http://www.xiph.org/">Xiph.org</a></li>
          
            <li><a href="http://www.opus-codec.org/">Opus</a></li>
          
            <li><a href="http://xiph.org/flac/">FLAC</a></li>
          
            <li><a href="http://www.icecast.org/">Icecast</a></li>
          
            <li><a href="http://www.vorbis.com/">Vorbis</a></li>
          
            <li><a href="http://www.theora.org/">Theora</a></li>
          
            <li><a href="http://www.speex.org/">Speex</a></li>
          
            <li><a href="http://www.xspf.org/">XSPF</a></li>
          
        </ul>
        
      </div>
</div>
<header>
<h1>Are We Compressed Yet?</h1>
</header>
<noscript>Sorry, this website currently requires <a href="https://www.destroyallsoftware.com/talks/the-birth-and-death-of-javascript">Javascript</a>.</noscript>
<article>
  <div id="runbox">
    <h2>Runs</h2>
    <select id="run_filter_task" onChange="load_runs()">
      <option value="video-1-short">video-1-short</option>
      <option value="subset1">subset1</option>
      <option value="subset2">subset2</option>
      <option value="subset3">subset3</option>
      <option value="subset4">subset4</option>
    </select>
    <div id="runs">
    </div>
  </div>
  <div id="graphbox">
    <h2>Graph</h2>
    <select id="metric" onChange="regenerate_graph()">
      <option value="0">PSNR</option>
      <option value="1">PSNR-HVS</option>
      <option value="2">SSIM</option>
      <option value="3" selected>FASTSSIM</option>
    </select>
    <select id="video_name" onChange="regenerate_graph()" style="width: 300px">
      <option value="total.out">Total</option>
    </select>
    <div class="graph_box">
      <div id="rd_graph">
        ⟵Click runs on the left to select.
      </div>
      <label><input id="logarithmic" type="checkbox" checked onChange="regenerate_graph()"></input>Logarithmic</label>
    </div>
    <div class="controlarea">
      <div class="controlbox">
        <h2>BD rate</h2>
        <p id="bd_rate_title"></p>
        <pre id="bd_rate"></pre>
      </div>
      <div class="controlbox">
        <h2>Current job</h2>
        <div id="current_job">No jobs running</div>
      </div>
      <div class="controlbox">
        <h2>Job queue</h2>
        <div id="job_queue"></div>
      </div>
      <div class="controlbox">
        <h2>Submit job</h2>
        <form action="submit/job" method="post">
          <label>Run ID<input name="run_id" id="run_id"></input></label>
          <label>Commit Hash<input name="commit"></input></label>
          <label>Subset
            <select name="task">
              <option value="video-1-short">video-1-short</option>
              <option value="subset1">subset1</option>
              <option value="subset2">subset2</option>
              <option value="subset3">subset3</option>
              <option value="subset4">subset4</option>
            </select>
          </label>
          <label>IRC nick<input name="nick" value="AWCY"></input></label>
          <label>Key<input name="key"></input></label>
          <input type="submit"></input>
        </form>
      </div>
    </div>
  </div>
</article>
</body>
</html>
