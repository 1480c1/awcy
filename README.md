Are We Compressed Yet?
====
This repository contains the arewecompressedyet.com website source code.

Running your own local copy of the website
===
To run a local copy, you will need a copy of node and npm.

You will need node, npm, etc. For Ubuntu:
```
sudo apt install nodejs npm nodejs-legacy libicu-dev
```
You'll also need tools to build AV1 or other codecs being tested:
```
sudo apt install yasm libtool
```

First, run the `./setup.sh` script. It will create directories needed for AWCY to run.

Next, create a configuration file called `config.json`.

Here is an example config.json:

```
{ "channel": "#daalatest",
  "have_aws": false,
  "port": 3000,
  "rd_server_url": "http://localhost:4000"
}
```

You will also need a file called `secret_key` which contains the key needed to use the website.

```
echo 'fake_password_to_compile' > secret_key
```

These commands will create the configuration files and install the node.js modules that get used by
awcy. Open a node command line and run the following:

```
cd www
npm install
cd ..
npm install
npm start
```

To run the server, execute the run_awcy.bat file
or run the following in your command line:
```
  node awcy_server.js
```
Now you can open localhost:3000 with your browser to see your local version of the website.

Setting up repositories
===
For the website to build codecs, you need local checkouts of every codec. While the `./setup.sh` script
automatically adds AV1, you can add your own. For example:
```
git clone https://aomedia.googlesource.com/aom av1
ln -s av1 av1-rt
```

Setting up rd_server
===
The AWCY web server manages the repositories and runs/ directory, and compiles and builds the codecs. Once this is done, it hands off the job of actually talking to all the AWS machines to rd_server.

To install rd_server, checkout the rd_tool repository in the same directory as awcy:
```
git clone https://github.com/tdaede/rd_tool.git
```

Then start the rd_server.py daemon:
```
./rd_server.py
```
The rd_server.py daemon listens on port 4000 by default.

More documentation on rd_server.py can be found in its README.

Run database format
===
The runs/ directory will contain all of the output files generated from a job. There is a info.json file that specifies what options were used by that particular run. Here is an example of an info.json file:

  {"codec":"daala","commit":"","run_id":"2014-09-19T22-00-08.196Z","task":"video-1-short","nick":"AWCY","task_type":"video"}

There is also an output.txt file that contains the output of the rd_tool.py script.

After each run, a cache file called list.json file is generated by the generate_list.js script. This contains all of the info.json files, as an ordered list. This should probably be replaced by a "real" database at some point.

Docker support
===

AWCY can be started as a docker container for local usage or development.

Build
----

The docker image is pretty large (3.3 GB), as it includes:

 * build dependencies for all codecs to be built (gcc/g++, autotools, make, rust, ...)
 * build dependencies for the WebUI (nodejs, emscripten, ...)
 * runtime dependencies for build and analysis scripts (python, daalatool, ...)

Note: this image has not been optimized for size yet, and may be split in the future.

To build the image:

```sh
docker build --tag xiph/awcy:latest .
```

Run
----

You can run an all-in-one container which will start:

 * awcy server
 * rd_server
 * sshd (to emulate a local rd_tool worker)

In addition, a git clone of every codecs' source is going to be done from upstream at initial startup.

Configuration is driven by a few environment variables (with their default values):

 * `CONFIG_DIR=/data/conf`: configuration files, sqlite database, generate SSH keys, set list, ...
 * `CODECS_SRC_DIR=/data/src`: where codecs' sources are going to be cloned (and compiled)
 * `RUNS_DST_DIR=/data/runs`: rd_tool jobs runs output
 * `WORK_DIR=/data/work`: rd_tool job workdir directory
 * `MEDIAS_SRC_DIR=/data/media`: directory containing media files ( get them from https://people.xiph.org/~tdaede/sets/ )
 * `LOCAL_WORKER_ENABLED=false`: if a local worker need to be started and configured
 * `LOCAL_WORKER_SLOTS=$(nproc)`: number of slots for the local worker
 * `IRC_CHANNEL=#daalatest`: IRC notifications target channel
 * `AWCY_API_KEY=awcy_api_key`: WebUI/API key
 * `AWCY_SERVER_PORT=3000`: awcy server listening port
 * `RD_SERVER_PORT=4000`: rd_server listening port

Simple run example (all data will be contained on the docker host in `/tmp/awcy`):

```sh
docker run \
	-it \
	--rm \
	--name xiph-awcy \
	--volume /tmp/awcy:/data \
	--volume ${HOME}/xiph-media-files:/media \
	--env MEDIAS_SRC_DIR=/media \
	--env AWCY_API_KEY=complicated_password \
	--env LOCAL_WORKER_ENABLED=true \
	--env LOCAL_WORKER_SLOTS=4 \
	xiph/awcy:latest
```

Output:

```
Cloning into '/data/src/av1'...
remote: Sending approximately 132.14 MiB ...
remote: Counting objects: 8, done
remote: Finding sources: 100% (5/5)
remote: Total 193273 (delta 156479), reused 193273 (delta 156479)
Receiving objects: 100% (193273/193273), 132.11 MiB | 2.33 MiB/s, done.
Resolving deltas: 100% (156479/156479), done.
Cloning into '/data/src/daala'...
remote: Enumerating objects: 12671, done.
remote: Total 12671 (delta 0), reused 0 (delta 0), pack-reused 12671
Receiving objects: 100% (12671/12671), 8.70 MiB | 2.37 MiB/s, done.
Resolving deltas: 100% (9442/9442), done.
Cloning into '/data/src/rav1e'...
remote: Enumerating objects: 1, done.
remote: Counting objects: 100% (1/1), done.
remote: Total 4426 (delta 0), reused 0 (delta 0), pack-reused 4425
Receiving objects: 100% (4426/4426), 2.61 MiB | 2.33 MiB/s, done.
Resolving deltas: 100% (3108/3108), done.
Cloning into '/data/src/thor'...

(...)

Generating public/private rsa key pair.
Your identification has been saved in /data/conf/awcy.pem.
Your public key has been saved in /data/conf/awcy.pem.pub.
The key fingerprint is:
SHA256:TJa3T7FZhByGZ3owJOtV/OXk75nyBJa8I7pq2BwNEaU xiph@4ee6bf6c8ffe
The key's randomart image is:
+---[RSA 2048]----+
|       .+o.++o.  |
|       ..++o*.  o|
|       E* o*...= |
|       * o..o=o o|
|        S ..+=  .|
|       . . o. o .|
|      + .  ..o oo|
|     . +  . ..oo.|
|      ...o.   o. |
+----[SHA256]-----+
STARTING SSHD SERVICE
STARTING AWCY SERVICE
STARTING RDTOOL SERVICE
AWCY server started! Open a browser at http://172.20.0.12:3000
AWCY server directory: /opt/app
Configuration directory: /data/conf
Codecs git repositories location: /data/src
Media samples directory: /media
Runs output directory: /data/runs
```

As said in the output, if you open your browser at http://172.20.0.12:3000, you should see the AWCY WebUI.

Cleanup
----

You can stop the container by hitting `CTRL+C`.

If you have started your container using the above example, all data is contained in `/tmp/awcy`, so you can removed this directory from your host.